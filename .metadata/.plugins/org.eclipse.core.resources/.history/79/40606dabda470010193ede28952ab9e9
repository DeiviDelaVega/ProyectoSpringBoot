package com.polo.webreservas.controller;


import com.polo.webreservas.model.Reserva;
import com.polo.webreservas.service.InmuebleService;
import com.polo.webreservas.service.ReservaService;
import jakarta.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Controller
@RequestMapping("/reservas")
public class ReservaController {

    @Autowired
    private ReservaService reservaService;

    @Autowired
    private InmuebleService inmuebleService;

    // Mostrar lista de reservas
    @GetMapping
    public String listarReservas(Model model) {
        List<Reserva> reservas = reservaService.listarTodas();
        model.addAttribute("reservas", reservas);
        return "reserva/lista"; // Asegúrate de tener esta vista
    }

    // Mostrar formulario para nueva reserva
    @GetMapping("/nueva")
    public String mostrarFormularioNueva(Model model) {
        model.addAttribute("reserva", new Reserva());
        model.addAttribute("inmuebles", inmuebleService.listarTodos());
        return "reserva/formulario"; // Vista con formulario
    }

    // Guardar nueva reserva
    @PostMapping("/guardar")
    public String guardarReserva(@Valid @ModelAttribute("reserva") Reserva reserva,
                                 BindingResult result,
                                 Model model) {
        if (result.hasErrors()) {
            model.addAttribute("inmuebles", inmuebleService.listarTodos());
            return "reserva/formulario";
        }
        reservaService.guardar(reserva);
        return "redirect:/reservas";
    }

    // Mostrar formulario de edición
    @GetMapping("/editar/{id}")
    public String mostrarFormularioEditar(@PathVariable Integer id, Model model) {
        Reserva reserva = reservaService.buscarPorId(id);
        if (reserva == null) {
            return "redirect:/reservas";
        }
        model.addAttribute("reserva", reserva);
        model.addAttribute("inmuebles", inmuebleService.listarTodos());
        return "reserva/formulario";
    }

    @GetMapping("/reservas/filtro")
    public String mostrarFormularioFiltro(Model model) {
        model.addAttribute("clientes", clienteRepository.findAll()); // asegúrate de inyectar `clienteRepository`
        return "reserva/filtro";
    }

    @PostMapping("/reservas/filtro")
    public String filtrarReservas(
        @RequestParam(required = false) Integer clienteId,
        @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate fechaInicio,
        Model model
    ) {
        List<Reserva> reservas = reservaService.filtrarReservas(clienteId, fechaInicio);
        model.addAttribute("reservas", reservas);
        model.addAttribute("clientes", clienteRepository.findAll());
        return "reserva/filtro";
    }


}
